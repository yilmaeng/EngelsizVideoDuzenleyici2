name: Mac ARM64 Only Build (Experiment)

on:
  workflow_dispatch:

jobs:
  build-mac-arm:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        # This uses the original package.json and package-lock.json first
        run: npm ci

      - name: Overwrite package.json with ARM Config
        # We write the ARM-only configuration directly here to avoid "file not found" issues
        run: |
          cat <<EOF > package.json
          {
            "name": "korcul-video-editor",
            "version": "3.0.0-RC",
            "description": "Bir video oynatıcıyı klavyeyle kontrol eden el ve kulak - Görme engelli kullanıcılar için erişilebilir video düzenleme",
            "main": "src/main/index.js",
            "scripts": {
              "start": "electron .",
              "start:win": "set ELECTRON_RUN_AS_NODE= && electron .",
              "dev": "electron . --enable-logging",
              "build": "electron-builder",
              "build:win": "electron-builder --win --x64",
              "build:mac": "electron-builder --mac",
              "build:linux": "electron-builder --linux",
              "build:all": "electron-builder --win --mac --linux",
              "test": "echo \"Test komutları henüz eklenmedi\" && exit 0"
            },
            "build": {
              "appId": "com.engelsiz.videoeditor",
              "productName": "Engelsiz Video Düzenleyicisi",
              "copyright": "© 2025 Engin Yılmaz",
              "mac": {
                "target": [
                  {
                    "target": "dmg",
                    "arch": [
                      "arm64"
                    ]
                  }
                ],
                "icon": "Start_icon.png",
                "category": "public.app-category.video",
                "hardenedRuntime": false,
                "gatekeeperAssess": false,
                "identity": null,
                "type": "development"
              },
              "electronLanguages": [
                "tr"
              ],
              "portable": {
                "artifactName": "\${productName}-Portable-v\${version}.\${ext}"
              },
              "files": [
                "src/**/*",
                "Start_icon.png",
                "Geçiş Sesleri/**/*",
                "Animation Sounds/**/*",
                "!src/test/**/*",
                "!**/*.md",
                "!**/*.map",
                "!**/*.log",
                "!**/backup_*/**/*",
                "!**/.agent/**/*"
              ],
              "extraResources": [
                {
                  "from": "src/renderer/assets/sfx",
                  "to": "assets/sfx"
                }
              ],
              "asar": true,
              "asarUnpack": [
                "node_modules/@ffmpeg-installer/**/*",
                "node_modules/@ffprobe-installer/**/*",
                "node_modules/sharp/**/*",
                "node_modules/say/**/*",
                "node_modules/@xenova/**/*"
              ],
              "npmRebuild": true,
              "publish": null
            },
            "keywords": [
              "video-editor",
              "accessibility",
              "screen-reader",
              "nvda",
              "jaws",
              "blind",
              "keyboard"
            ],
            "author": "Engin Yılmaz",
            "license": "MIT",
            "devDependencies": {
              "electron": "^28.3.3",
              "electron-builder": "^25.1.8"
            },
            "dependencies": {
              "@ffmpeg-installer/ffmpeg": "^1.1.0",
              "@ffprobe-installer/ffprobe": "^2.1.2",
              "@xenova/transformers": "^2.17.2",
              "edge-tts": "^1.0.1",
              "fluent-ffmpeg": "^2.1.3",
              "jimp": "^1.6.0",
              "node-gtts": "^2.0.2",
              "say": "^0.16.0",
              "sharp": "^0.34.5",
              "wav": "^1.0.2"
            }
          }
          EOF
          
          echo "=== New package.json content ==="
          cat package.json

      - name: Build Mac (ARM64 Only)
        run: |
          echo "Starting Mac ARM64 build..."
          # package.json is now ARM-only
          npm run build:mac 2>&1 | tee build_output.log
          
      - name: List Output
        run: |
          ls -R dist/

      - name: Upload Mac ARM64 DMG
        uses: actions/upload-artifact@v4
        with:
          name: mac-arm64-dmg-experimental-v2
          path: dist/*.dmg
          retention-days: 5
